const headings = document.querySelectorAll('.wp-block-heading');
const vulNames = [];
const sections = [];

if (headings.length) {
  headings.forEach( (e) => {
    // Get Vulnerability section name
    // Assuring it is a title
    var block = e.nextElementSibling;
    while ( ! block.classList.contains('wp-block-solidwp-vulnerability-roundup') ) {
      block = block.nextElementSibling;
    }

    sections.push({
      'section': e.innerText,
      'sectionLength': block.children.length
    });
  });

  var heads = document.querySelectorAll('.solidwp-vulnerability__heading');
  heads.forEach((e) => {
    var fix = Array.from(
      e.parentNode
        .nextElementSibling
        .querySelectorAll('.solidwp-vulnerability__grid_item')
    ).filter( e => e.querySelector('dt').innerText === 'Patched in Version:')

    if (fix.length) {
      fix = fix[0].querySelector('dd').innerText;
    }

    var name = e.innerText
      .trim()
      .split('â€“');
    
    if (name.length === 2 ) {
      if ( name[0].length > name[1].length ) {
        name = name[1];
      } else {
        name = name[0];
      }
    } else {
      name = name[0]
    }

    vulNames.push({
      'name': name.trim(),
      'fix': fix || 'none',
    });
  });
}

chrome.storage.local.set({
  names: vulNames,
  sections: sections
});